name: "CI/CD for a PostgreSQL Docker image"

run-name: "#${{ github.run_number }}-${{ github.run_attempt }} on ${{ github.event_name }} by ${{ github.actor }}"

on:
  push:
    path:
      - 'Dockerfile**'
      - 'entrypoint'
      - 'Makefile'
  pull_request:
  workflow_dispatch:
  workflow_call:
    inputs:
      is_called:
        description: "Is called by another actions"
        default: false
        type: boolean

jobs:
  info:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ’¬ github"
        run: |+
          echo "Who launched:       ${{ github.actor }}"
          echo "On branch:          ${{ github.ref_name }}"
          echo "Commit sha:         ${{ github.sha }}"
          echo "Trigger event name  ${{ github.event_name }}"

      - name: "ğŸ’¬ Docker info"
        run: |+
          docker --version
          docker compose version
          docker buildx version

  build_publish:
    strategy:
      max-parallel: 1
      matrix:
        tags: [
          "edge",
          "latest",
        ]

    runs-on: ubuntu-latest
    steps:
      - name: â˜ï¸ Retrieve repo
        uses: actions/checkout@v3

      - name: ğŸ¤– Build ${{ matrix.tags }}
        timeout-minutes: 2
        run: make TAG=${{ matrix.tags }} test

      - name: â˜ï¸ Login on Docker.io
        run: docker login --username "${{ secrets.DOCKER_USER }}" --password-stdin <<<"${{ secrets.DOCKER_PAT }}"

      - name: â˜ï¸ Publishing ${{ matrix.tags }}
        run: docker push ${{ secrets.DOCKER_USER }}/postgresql:${{ matrix.tags }}
